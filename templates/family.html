{% extends "base.html" %}
{% block content %}

<h1 class="text-3xl font-bold mb-6 text-blue-300">Family Library</h1>

<div class="flex gap-4 mb-4">
    <a href="{{ url_for('catalog.family', sort='alpha') }}"
       class="px-3 py-1 rounded {{ 'bg-blue-600' if sort=='alpha' else 'bg-gray-700' }}">
        Aâ€“Z
    </a>

    <a href="{{ url_for('catalog.family', sort='hours') }}"
       class="px-3 py-1 rounded {{ 'bg-blue-600' if sort=='hours' else 'bg-gray-700' }}">
        Total Hours
    </a>

    <a href="{{ url_for('catalog.family', sort='rating') }}"
       class="px-3 py-1 rounded {{ 'bg-blue-600' if sort=='rating' else 'bg-gray-700' }}">
        Avg Rating
    </a>
</div>


<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">

    {% for game in games %}

    <div class="group bg-gray-800 rounded-lg shadow hover:shadow-xl transition-all">

        <!-- COVER -->
        <div class="relative overflow-hidden rounded-t-lg">

            <a href="{{ url_for('catalog.game_detail', appid=game.appid) }}">
                <img src="{{ game.cover_url }}"
                     onerror="this.src='https://placehold.co/600x900?text=No+Cover';"
                     class="w-full h-auto">
            </a>

            <!-- SORTED AVATARS -->
            <div class="absolute top-2 left-2 flex space-x-1 z-20">

                {% set sorted = game.members|sort(attribute='hours', reverse=True) %}

                {% for member in sorted %}
                    {% if member.hours and member.hours|float > 0 %}

                    <div class="group/avatar relative">

                        <a href="/user/{{ member.user_id }}/stats">
                            <img src="{{ member.avatar_url }}" class="rounded-full w-8 h-8 hover:opacity-80 transition">
                        </a>

                        <div class="absolute left-9 top-0 bg-black/90 text-sm p-3 rounded shadow-xl
                                    hidden group-hover/avatar:block w-56 z-50 pointer-events-auto">

                            <p class="font-semibold">{{ member.display_name }}</p>

                            <p class="text-gray-300">
                                Rating:
                                {% if member.rating %}
                                    {{ member.rating }}
                                {% else %}
                                    --
                                {% endif %}
                            </p>

                            <p class="text-gray-300">
                                {{ member.hours|float|round(1) }} hrs
                            </p>

                            {% if member.notes %}
                            <p class="italic text-gray-400 mt-2">"{{ member.notes }}"</p>
                            {% endif %}
                        </div>

                    </div>


                    {% endif %}
                {% endfor %}

            </div>

        </div>

        <!-- LOWER BLOCK -->
        <div class="p-3">

            <a href="{{ url_for('catalog.game_detail', appid=game.appid) }}">
                <h2 class="text-base font-semibold mb-2 truncate">{{ game.title }}</h2>
            </a>

            <!-- YOUR RATING -->
            <div class="flex items-center justify-between mb-1">
                <p class="text-gray-300 text-xs">Your rating:</p>

                {% for member in game.members %}
                    {% if member.user_id == current_user.id %}
                    <select class="bg-gray-700 text-white p-1 rounded text-xs"
                            onchange="updateRating({{ game.appid }}, this.value)"
                            onclick="event.stopPropagation();">
                        <option value="">--</option>
                        {% for n in range(1, 11) %}
                        <option value="{{ n }}" {% if member.rating == n %}selected{% endif %}>
                            {{ n }}
                        </option>
                        {% endfor %}
                    </select>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- FAMILY AVG + TOTAL HOURS -->
            {% set ratings = [] %}
            {% set total_hours = 0 %}
            {% for member in game.members %}
                {% if member.rating %}
                    {% set _ = ratings.append(member.rating) %}
                {% endif %}
                {% if member.hours %}
                    {% set total_hours = total_hours + member.hours %}
                {% endif %}
            {% endfor %}

            <p class="text-gray-400 text-xs">
                Family avg:
                {% if ratings|length > 0 %}
                    {{ (ratings|sum / ratings|length)|round(1) }}
                {% else %}
                    --
                {% endif %}
            </p>

            <p class="text-gray-400 text-xs">
                Total hours: {{ game.total_hours|round(1) }}
            </p>

        </div>

    </div>
    {% endfor %}
</div>


<script>
function updateRating(appid, rating) {
    fetch(`/family/rate/${appid}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rating: rating })
    }).then(() => {
        setTimeout(() => window.location.reload(), 150);
    });
}
</script>

{% endblock %}
